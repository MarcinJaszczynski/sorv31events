<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SortableJS Test for Kanban</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
    <style>
        .kanban-container { display: flex; gap: 20px; margin: 20px; }
        .kanban-dropzone { 
            min-width: 250px; 
            min-height: 300px; 
            border: 2px dashed #ccc; 
            padding: 10px; 
            background: #f9f9f9;
        }
        .kanban-item { 
            background: white; 
            padding: 10px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            cursor: move;
            border-radius: 4px;
        }
        .sortable-ghost { opacity: 0.5; }
        .debug-info { 
            margin: 20px; 
            padding: 15px; 
            background: #e8f4f8; 
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>Test SortableJS dla Kanban</h1>
    
    <div class="debug-info">
        <h3>Status:</h3>
        <div id="status"></div>
        <button onclick="testDragDrop()">Przetestuj drag & drop</button> 
        <button onclick="sendToBackend()">Wyślij do backendu</button>
        <button onclick="clearLogs()">Wyczyść logi</button>
        <h3>Logi:</h3>
        <div id="logs"></div>
    </div>
    
    <div class="kanban-container">
        <div class="kanban-dropzone" data-day="1">
            <h3>Dzień 1</h3>
            <div class="kanban-item" data-pivot-id="1">Element 1 (pivot-id: 1)</div>
            <div class="kanban-item" data-pivot-id="3">Element 3 (pivot-id: 3)</div>
        </div>
        
        <div class="kanban-dropzone" data-day="2">
            <h3>Dzień 2</h3>
            <div class="kanban-item" data-pivot-id="2">Element 2 (pivot-id: 2)</div>
            <div class="kanban-item" data-pivot-id="4">Element 4 (pivot-id: 4)</div>
        </div>
        
        <div class="kanban-dropzone" data-day="3">
            <h3>Dzień 3</h3>
            <div class="kanban-item" data-pivot-id="5">Element 5 (pivot-id: 5)</div>
        </div>
    </div>
    
    <script>
        let logs = [];
        let sortableInstances = [];
        
        function addLog(message) {
            logs.push(new Date().toLocaleTimeString() + ': ' + message);
            document.getElementById('logs').innerHTML = logs.slice(-10).join('<br>');
            console.log(message);
        }
        
        function clearLogs() {
            logs = [];
            document.getElementById('logs').innerHTML = '';
        }
        
        function updateStatus() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `
                SortableJS: ${typeof Sortable !== 'undefined' ? 'DOSTĘPNY' : 'NIEDOSTĘPNY'}<br>
                Instancje Sortable: ${sortableInstances.length}<br>
                Zones: ${document.querySelectorAll('.kanban-dropzone').length}<br>
                Items: ${document.querySelectorAll('.kanban-item').length}
            `;
        }
        
        function initSortable() {
            addLog('Inicjalizacja SortableJS...');
            
            // Usuń stare instancje
            sortableInstances.forEach(instance => {
                if (instance && instance.destroy) {
                    instance.destroy();
                }
            });
            sortableInstances = [];
            
            // Utwórz nowe instancje
            document.querySelectorAll('.kanban-dropzone').forEach((zone, index) => {
                const instance = new Sortable(zone, {
                    group: 'kanban-test',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onStart: function(evt) {
                        const pivotId = evt.item.getAttribute('data-pivot-id');
                        const fromDay = evt.from.getAttribute('data-day');
                        addLog(`Drag START: pivot-id=${pivotId}, from day=${fromDay}`);
                    },
                    onEnd: function(evt) {
                        const pivotId = evt.item.getAttribute('data-pivot-id');
                        const fromDay = evt.from.getAttribute('data-day');
                        const toDay = evt.to.getAttribute('data-day');
                        
                        // Pobierz pełną kolejność w docelowej zone
                        const fullOrder = Array.from(evt.to.children)
                            .filter(el => el.classList.contains('kanban-item'))
                            .map(el => el.getAttribute('data-pivot-id'));
                        
                        addLog(`Drag END: pivot-id=${pivotId}, from day=${fromDay}, to day=${toDay}, order=[${fullOrder.join(',')}]`);
                        
                        // Tu wywołalibyśmy backend
                        // movePoint(pivotId, toDay, fullOrder);
                    }
                });
                
                sortableInstances.push(instance);
                addLog(`Utworzono instancję ${index + 1} dla dnia ${zone.getAttribute('data-day')}`);
            });
            
            updateStatus();
        }
        
        function testDragDrop() {
            addLog('=== TEST DRAG & DROP ===');
            addLog('Przeciągnij elementy między kolumnami aby przetestować');
            addLog('sprawdź logi powyżej aby zobaczyć czy eventy są wywoływane');
        }
        
        function sendToBackend() {
            // Symulacja wysłania do backendu Laravel
            const testData = {
                pivotId: 2,
                newDay: 1,
                fullOrder: [3, 2, 1]
            };
            
            addLog('Wysyłanie danych do /test-drag-drop...');
            
            fetch('/test-drag-drop', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.text())
            .then(data => {
                addLog('Odpowiedź z backendu: ' + data);
            })
            .catch(error => {
                addLog('Błąd komunikacji: ' + error.message);
            });
        }
        
        // Inicjalizacja po załadowaniu strony
        document.addEventListener('DOMContentLoaded', function() {
            addLog('Strona załadowana');
            updateStatus();
            initSortable();
            addLog('Inicjalizacja zakończona');
        });
    </script>
</body>
</html>
